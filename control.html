<!doctype html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Picker Tabs — Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#"><i class="bi bi-sliders me-2"></i>Picker Tabs <span class="badge text-bg-primary ms-1">Control</span></a>
    <div class="d-flex gap-2">
      <input id="pin" class="form-control form-control-sm" type="password" placeholder="PIN" style="width:160px">
      <button id="btnPublish" class="btn btn-sm btn-dark"><i class="bi bi-cloud-arrow-up me-1"></i>Publish</button>
    </div>
  </div>
</nav>

<main class="container py-3">
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Judul Tab</label>
          <input id="title" class="form-control" placeholder="Mis. DPK Des-24">
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipe</label>
          <select id="type" class="form-select">
            <option value="pdf">PDF</option>
            <option value="image">IMAGE</option>
            <option value="link">LINK</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">URL</label>
          <div class="input-group">
            <input id="url" class="form-control" placeholder="Tempel URL atau pilih dari Server (/assets)…">
            <button class="btn btn-outline-secondary" id="btnPick"><i class="bi bi-hdd-network"></i> Pilih dari Server</button>
            <button class="btn btn-success" id="btnAdd"><i class="bi bi-plus-lg"></i> Tambah</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold">Daftar Tab</div>
        <div class="text-secondary small">Total: <span id="count">0</span></div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle" id="tabTable">
          <thead class="table-light">
            <tr>
              <th style="width:40px"></th>
              <th>Judul</th>
              <th style="width:110px">Tipe</th>
              <th>URL</th>
              <th style="width:120px">Aksi</th>
            </tr>
          </thead>
          <tbody id="tabBody"></tbody>
        </table>
      </div>

      <div class="alert alert-info mb-0"><i class="bi bi-info-circle me-1"></i>Drag handle <i class="bi bi-grip-vertical"></i> untuk mengurutkan. Klik <b>Publish</b> untuk menyimpan & mengirim ke layar bos.</div>
    </div>
  </div>
</main>

<!-- Modal File Picker (local /assets) -->
<div class="modal fade" id="pickerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-hdd-network me-2"></i>Pilih File dari Server (/assets)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex gap-2 align-items-center mb-2">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0" id="crumb"></ol>
          </nav>
          <div class="ms-auto d-flex gap-2">
            <select id="filterExt" class="form-select form-select-sm" style="width:160px">
              <option value="">Semua ekstensi</option>
              <option>pdf</option>
              <option>png</option>
              <option>jpg</option>
              <option>jpeg</option>
              <option>webp</option>
              <option>svg</option>
            </select>
            <input id="search" class="form-control form-control-sm" placeholder="Cari nama file…" style="width:220px">
          </div>
        </div>
        <div class="table-responsive border rounded">
          <table class="table table-hover table-sm mb-0">
            <thead class="table-light">
              <tr><th style="width:36px"></th><th>Nama</th><th>Path</th><th style="width:120px">Pilih</th></tr>
            </thead>
            <tbody id="pickerBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-check-circle text-success me-2"></i>
      <strong class="me-auto">Berhasil</strong>
      <small>sekarang</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastBody">Tersimpan.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
let manifest = { rev: 1, activeIndex: 0, tabs: [], updatedAt: new Date().toISOString() };

const tabBody = document.getElementById('tabBody');
const countEl = document.getElementById('count');
const toast = new bootstrap.Toast(document.getElementById('toast'));
const toastBody = document.getElementById('toastBody');
const STORAGE_KEY = 'picker-tabs:last-update';
const broadcast = 'BroadcastChannel' in window ? new BroadcastChannel('picker-tabs') : null;

function uid(){ return Math.random().toString(36).slice(2); }
function iconByType(t){ return t==='pdf'?'bi-filetype-pdf':t==='image'?'bi-image':'bi-link-45deg'; }
function isLocal(url){ return url.startsWith('/assets/') || url.startsWith('/boss-tabs/assets/'); }

async function fetchManifestData(){
  const ts = Date.now();
  const sources = [`manifest.json?ts=${ts}`, `/api/manifest?ts=${ts}`];
  let best = null;
  let bestRev = -Infinity;
  let bestUpdated = -Infinity;

  for (const url of sources) {
    try {
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) continue;
      const data = await res.json();
      if (data && typeof data === 'object' && Array.isArray(data.tabs)) {
        const rev = Number(data.rev) || 0;
        const updatedAt = Date.parse(data.updatedAt || '') || 0;
        if (!best || rev > bestRev || (rev === bestRev && updatedAt > bestUpdated)) {
          best = data;
          bestRev = rev;
          bestUpdated = updatedAt;
        }
      }
    } catch (err) {
      // continue to the next source
    }
  }

  return best;
}

function renderList(){
  tabBody.innerHTML='';
  manifest.tabs.forEach((t, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-secondary" style="cursor:grab"><i class="bi bi-grip-vertical"></i></td>
      <td class="fw-semibold">${t.title}</td>
      <td><span class="badge text-bg-secondary badge-type"><i class="bi ${iconByType(t.type)} me-1"></i>${t.type.toUpperCase()}</span></td>
      <td class="text-truncate" style="max-width:460px" title="${t.url}">${t.url}</td>
      <td class="text-nowrap">
        <button class="btn btn-sm btn-outline-primary me-1" data-act="preview"><i class="bi bi-eye"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-act="del"><i class="bi bi-trash"></i></button>
      </td>`;
    tr.querySelector('[data-act="del"]').onclick = () => { manifest.tabs.splice(i,1); renderList(); };
    tr.querySelector('[data-act="preview"]').onclick = () => {
      const u = isLocal(t.url) ? t.url : ('/api/proxy?url='+encodeURIComponent(t.url));
      window.open(t.type === 'link' ? t.url : u , '_blank');
    };
    tabBody.appendChild(tr);
  });
  countEl.textContent = manifest.tabs.length;
}

new Sortable(tabBody, {
  handle: 'td:first-child',
  animation: 150,
  onEnd: (evt) => {
    const { oldIndex, newIndex } = evt;
    if (oldIndex===newIndex) return;
    const item = manifest.tabs.splice(oldIndex,1)[0];
    manifest.tabs.splice(newIndex,0,item);
    renderList();
  }
});

async function loadManifest(){
  try{
    const data = await fetchManifestData();
    if (data) {
      manifest = data;
      renderList();
    }
  }catch(e){}
}

// Tambah tab
btnAdd.onclick = () => {
  const title = document.getElementById('title').value.trim();
  const type  = document.getElementById('type').value;
  const url   = document.getElementById('url').value.trim();
  if(!title || !url){ alert('Lengkapi judul & URL'); return; }
  manifest.tabs.push({ id: uid(), title, type, url });
  document.getElementById('title').value='';
  document.getElementById('url').value='';
  renderList();
};

function normalizeErrorText(value, visited = new Set()) {
  if (value == null) return null;
  if (typeof value === 'string') {
    let trimmed = value.trim();
    if (!trimmed) return null;

    if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
      try {
        const parsed = JSON.parse(trimmed);
        const parsedMessage = normalizeErrorText(parsed, visited);
        if (parsedMessage) return parsedMessage;
      } catch (err) {}
    }

    if (/\[object Object\]/i.test(trimmed)) {
      trimmed = trimmed.replace(/\[object Object\]/gi, ' ').replace(/\s+/g, ' ').trim();
    }

    if (!trimmed || trimmed === '[object Object]' || /^Error:?$/i.test(trimmed)) return null;
    return trimmed;
  }
  if (typeof value === 'number' || typeof value === 'boolean' || typeof value === 'bigint') {
    return String(value);
  }
  if (value instanceof Error) {
    return normalizeErrorText(value.message, visited);
  }
  if (typeof value === 'object') {
    if (visited.has(value)) return null;
    visited.add(value);

    if (Array.isArray(value)) {
      for (const entry of value) {
        const result = normalizeErrorText(entry, visited);
        if (result) return result;
      }
      return null;
    }

    const preferredKeys = ['message', 'detail', 'error', 'reason', 'description', 'info', 'text', 'cause'];
    for (const key of preferredKeys) {
      if (key in value) {
        const result = normalizeErrorText(value[key], visited);
        if (result) return result;
      }
    }

    for (const key of Object.keys(value)) {
      if (preferredKeys.includes(key)) continue;
      const result = normalizeErrorText(value[key], visited);
      if (result) return result;
    }
  }

  return null;
}

async function publishManifest(payload){
  const endpoints = ['/api/save_manifest', '/save_manifest.php'];
  const DEFAULT_FALLBACK_PATH = '/tmp/manifest.json';
  let lastError = null;

  const normalizePath = (value) => {
    if (typeof value !== 'string') return null;
    const trimmed = value.trim();
    if (!trimmed) return null;
    if (trimmed.startsWith('file://')) {
      try {
        const fileUrl = new URL(trimmed);
        return fileUrl.pathname || null;
      } catch (err) {
        return trimmed.slice('file://'.length) || null;
      }
    }
    return trimmed;
  };

  const extractErrorMessage = (data) => {
    if (!data || typeof data !== 'object') return null;

    const primaryFields = ['error', 'message', 'detail', 'description', 'reason'];
    for (const field of primaryFields) {
      if (field in data) {
        const msg = normalizeErrorText(data[field]);
        if (msg) return msg;
      }
    }

    const collectionFields = ['errors', 'messages', 'details'];
    for (const field of collectionFields) {
      if (Array.isArray(data[field])) {
        for (const entry of data[field]) {
          const msg = normalizeErrorText(entry);
          if (msg) return msg;
        }
      }
    }

    return normalizeErrorText(data);
  };

  const isDefaultFallback = (value) => normalizePath(value) === DEFAULT_FALLBACK_PATH;

  for (const url of endpoints) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      const apiErrorMessage = extractErrorMessage(data);
      if (!response.ok) {
        const message = apiErrorMessage || `HTTP ${response.status}`;
        lastError = new Error(message);
        continue;
      }

      const fallbackInfo = data && typeof data === 'object' ? data.fallback : null;
      const failureDetected = [
        data && typeof data === 'object' ? data.location : null,
        fallbackInfo && typeof fallbackInfo.path === 'string' ? fallbackInfo.path : null,
        fallbackInfo && typeof fallbackInfo.location === 'string' ? fallbackInfo.location : null,
      ].some(isDefaultFallback);

      if (failureDetected) {
        const fallbackMessage = apiErrorMessage || `Backend ${url} hanya dapat menyimpan manifest ke lokasi sementara (${DEFAULT_FALLBACK_PATH}).`;
        lastError = new Error(fallbackMessage);
        continue;
      }

      return data;
    } catch (err) {
      const message = (err && err.message) ? err.message : null;
      lastError = new Error(message || `Gagal publish melalui ${url}`);
    }
  }

  throw lastError || new Error('Gagal publish');
}

if (typeof window !== 'undefined') {
  window.__control = Object.assign(window.__control || {}, { publishManifest });
}

// Publish
btnPublish.onclick = async () => {
  const pin = document.getElementById('pin').value;
  if(!pin){ alert('Masukkan PIN'); return; }
  const payload = { ...manifest, pin };
  try {
    const result = await publishManifest(payload);
    manifest = result.manifest || manifest;
    renderList();
    toastBody.textContent = 'Manifest terpublikasi (rev ' + manifest.rev + ').';
    toast.show();
    notifyDisplay(manifest);
  } catch (err) {
    const fallbackMsg = 'Tidak ada backend yang dapat menyimpan manifest secara permanen.';
    const detail = normalizeErrorText(err && err.message)
      || (err && typeof err === 'object' ? normalizeErrorText(err) : null)
      || fallbackMsg;
    const trimmed = detail.trim();
    const needsFallback = !trimmed.includes(fallbackMsg);
    const suffix = needsFallback ? `${trimmed.endsWith('.') ? '' : '.'} ${fallbackMsg}` : '';
    alert('Gagal publish: ' + trimmed + suffix);
  }
};

function notifyDisplay(nextManifest){
  const now = Date.now();
  const info = {
    type: 'manifest-updated',
    rev: nextManifest?.rev ?? null,
    updatedAt: nextManifest?.updatedAt ?? new Date(now).toISOString(),
    ts: now,
  };
  if (broadcast) {
    try { broadcast.postMessage(info); } catch (err) {}
  }
  try {
    const nonce = Math.random().toString(36).slice(2);
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...info, nonce }));
  } catch (err) {}
}

// ===== Local Picker (/assets) =====
const pickerModal = new bootstrap.Modal(document.getElementById('pickerModal'));
const pickerBody  = document.getElementById('pickerBody');
const crumb       = document.getElementById('crumb');
const filterExt   = document.getElementById('filterExt');
const search      = document.getElementById('search');

let curPath = ''; // kosong = root /assets

function setCrumb(){
  const segs = curPath ? curPath.split('/') : [];
  crumb.innerHTML = '';
  const mk = (name, path) => {
    const li = document.createElement('li');
    li.className = 'breadcrumb-item' + (path===curPath ? ' active' : '');
    if (path===curPath){ li.textContent = name || 'assets'; }
    else { const a = document.createElement('a'); a.href = '#'; a.textContent = name || 'assets'; a.onclick = ()=>{ curPath = path; loadDir(); }; li.appendChild(a); }
    return li;
  };
  crumb.appendChild(mk('assets',''));
  let acc='';
  segs.forEach((s,i)=>{ acc += (i?'/':'') + s; crumb.appendChild(mk(s, acc)); });
}

async function loadDir(){
  setCrumb();
  pickerBody.innerHTML = `<tr><td colspan=4 class="text-center text-secondary p-3"><div class="spinner-border me-2"></div>Memuat…</td></tr>`;
  try{
    const ENDPOINT = '/api/local_list';
    const r = await fetch(`${ENDPOINT}?path=${encodeURIComponent(curPath)}`, { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    if(!j.ok) throw new Error('API error');
    let items = j.items || [];
    const ext = filterExt.value;
    const q = search.value.trim().toLowerCase();
    if (ext) items = items.filter(x => x.type==='dir' || x.ext===ext);
    if (q)   items = items.filter(x => (x.name||'').toLowerCase().includes(q));

    const rows = [];
    for (const it of items){
      if (it.type==='dir') {
        rows.push(`<tr>
          <td><i class="bi bi-folder2 text-warning"></i></td>
          <td class="fw-semibold">${it.name}</td>
          <td class="text-secondary">${it.path}</td>
          <td><button class="btn btn-sm btn-outline-secondary" data-go="${it.path}"><i class="bi bi-arrow-right"></i></button></td>
        </tr>`);
      } else {
        const icon = it.ext==='pdf'? 'bi-filetype-pdf' : (['png','jpg','jpeg','webp','svg'].includes(it.ext)? 'bi-image' : 'bi-file-earmark');
        rows.push(`<tr>
          <td><i class="bi ${icon}"></i></td>
          <td class="fw-semibold">${it.name}</td>
          <td class="text-secondary">${it.path}</td>
          <td><button class="btn btn-sm btn-success" data-url="${encodeURIComponent(it.url)}"><i class="bi bi-check2"></i> Pilih</button></td>
        </tr>`);
      }
    }
    pickerBody.innerHTML = rows.join('') || '<tr><td colspan=4 class="text-center text-secondary p-3">Kosong</td></tr>';
    pickerBody.querySelectorAll('[data-go]').forEach(el => el.onclick = ()=>{ curPath = el.getAttribute('data-go'); loadDir(); });
    pickerBody.querySelectorAll('[data-url]').forEach(el => el.onclick = ()=>{ document.getElementById('url').value = decodeURIComponent(el.getAttribute('data-url')); pickerModal.hide(); });
  }catch(e){
    pickerBody.innerHTML = '<tr><td colspan=4 class="text-danger p-3">Gagal memuat</td></tr>';
  }
}

btnPick.onclick = () => { loadDir(); pickerModal.show(); };
filterExt.onchange = loadDir; search.oninput = () => { clearTimeout(window.__t); window.__t=setTimeout(loadDir, 200); };

// Init
loadManifest();
renderList();
</script>
</body>
</html>
