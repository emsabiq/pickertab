<!doctype html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Picker Tabs — Display</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#"><i class="bi bi-window-sidebar me-2"></i>Picker Tabs <span class="badge text-bg-success ms-1">Display</span></a>
    <div class="d-flex align-items-center gap-2 small">
      <span id="meta" class="text-secondary"></span>
      <button class="btn btn-sm btn-outline-secondary" id="btnRefresh" title="Refresh"><i class="bi bi-arrow-clockwise"></i></button>
    </div>
  </div>
</nav>

<main class="container py-3">
  <div class="mb-2 d-flex flex-wrap gap-2" id="tabButtons"></div>

  <div class="viewer" id="viewer">
    <div class="d-flex h-100 align-items-center justify-content-center text-secondary">
      <div class="text-center">
        <div class="spinner-border mb-2" role="status"></div>
        <div>Memuat…</div>
      </div>
    </div>
  </div>
</main>

<script>
let state = { rev: 0, activeIndex: 0, tabs: [], updatedAt: '' };

async function fetchManifestData() {
  const ts = Date.now();
  const sources = [`manifest.json?ts=${ts}`, `/api/manifest?ts=${ts}`];
  let best = null;
  let bestRev = -Infinity;
  let bestUpdated = -Infinity;

  for (const url of sources) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) continue;
      const data = await res.json();
      if (data && typeof data === 'object' && Array.isArray(data.tabs)) {
        const rev = Number(data.rev) || 0;
        const updatedAt = Date.parse(data.updatedAt || '') || 0;
        if (
          !best ||
          rev > bestRev ||
          (rev === bestRev && updatedAt > bestUpdated)
        ) {
          best = data;
          bestRev = rev;
          bestUpdated = updatedAt;
        }
      }
    } catch (err) {
      // ignore and try the next source
    }
  }

  return best;
}

function iconByType(t){ return t==='pdf'?'bi-filetype-pdf':t==='image'?'bi-image':'bi-link-45deg'; }
function isLocal(url){
  // anggap lokal jika mengarah ke folder assets di domain ini
  return url.startsWith('/assets/') || url.startsWith('/boss-tabs/assets/');
}

function renderTabs(){
  const wrap = document.getElementById('tabButtons');
  wrap.innerHTML = '';
  state.tabs.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm ' + (i===state.activeIndex ? 'btn-success' : 'btn-outline-success');
    btn.innerHTML = `<i class="bi ${iconByType(t.type)} me-1"></i>${t.title}`;
    btn.onclick = () => { state.activeIndex = i; renderViewer(); renderTabs(); };
    wrap.appendChild(btn);
  });
}

function renderViewer(){
  const viewer = document.getElementById('viewer');
  viewer.innerHTML = '';
  if (!state.tabs.length) {
    viewer.innerHTML = '<div class="p-4 text-secondary">Belum ada tab. Minta operator publish dari Control.</div>';
    return;
  }
  const item = state.tabs[state.activeIndex] || state.tabs[0];
  const local = isLocal(item.url);

  if (item.type === 'image') {
    const img = document.createElement('img');
    img.src = local ? item.url : ('/api/proxy?url=' + encodeURIComponent(item.url));
    img.alt = item.title;
    viewer.appendChild(img);
  } else if (item.type === 'link') {
    const ifr = document.createElement('iframe');
    ifr.src = item.url; // link langsung
    ifr.title = item.title;
    viewer.appendChild(ifr);
  } else { // pdf
    const ifr = document.createElement('iframe');
    ifr.src = local ? item.url : ('/api/proxy?url=' + encodeURIComponent(item.url));
    ifr.title = item.title;
    viewer.appendChild(ifr);
  }
}

function parseUpdatedAt(value){
  if (value instanceof Date) {
    const ts = value.getTime();
    return Number.isNaN(ts) ? 0 : ts;
  }
  if (typeof value === 'number') {
    return Number.isFinite(value) ? value : 0;
  }
  if (typeof value === 'string') {
    const parsed = Date.parse(value);
    return Number.isNaN(parsed) ? 0 : parsed;
  }
  return 0;
}

function normalizeUpdatedAt(value){
  if (value instanceof Date) {
    return Number.isNaN(value.getTime()) ? '' : value.toISOString();
  }
  if (typeof value === 'number') {
    const ts = new Date(value);
    return Number.isNaN(ts.getTime()) ? '' : ts.toISOString();
  }
  if (typeof value === 'string') {
    return value;
  }
  if (value) {
    return String(value);
  }
  return '';
}

function renderMeta(){
  const m = document.getElementById('meta');
  m.textContent = `Rev: ${state.rev} · Updated: ${state.updatedAt? state.updatedAt.replace('T',' ').replace('Z',''):''}`;
}

async function load(){
  try {
    const data = await fetchManifestData();
    if (!data) return;
    const currentRev = Number(state?.rev) || 0;
    const incomingRev = Number(data?.rev) || 0;
    const currentUpdatedAt = state?.updatedAt ?? '';
    const incomingUpdatedAt = data?.updatedAt ?? '';
    const updatedChanged = `${currentUpdatedAt}` !== `${incomingUpdatedAt}`;
    const shouldRefresh =
      !Array.isArray(state.tabs) || !state.tabs.length ||
      currentRev !== incomingRev ||
      updatedChanged;

    if (shouldRefresh) {
      state = {
        ...data,
        rev: incomingRev,
        updatedAt: incomingUpdatedAt ? `${incomingUpdatedAt}` : '',
      };
      if (typeof state.activeIndex !== 'number') state.activeIndex = 0;
      renderTabs();
      renderViewer();
    }
    renderMeta();
  } catch (e) {}
}

// init
renderTabs(); renderViewer(); renderMeta();
load();
setInterval(load, 2000);

document.getElementById('btnRefresh').onclick = load;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
