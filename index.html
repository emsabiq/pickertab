<!doctype html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Picker Tabs — Display</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    /* fallback ringan kalau style.css belum mengatur viewer */
    .viewer { min-height: 70vh; background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; overflow:hidden }
    .viewer iframe, .viewer img { width:100%; height:70vh; border:0; object-fit:contain }
    @media (max-width: 576px){
      .viewer { min-height: 65vh }
      .viewer iframe, .viewer img { height:65vh }
    }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#"><i class="bi bi-window-sidebar me-2"></i>Picker Tabs <span class="badge text-bg-success ms-1">Display</span></a>
    <div class="d-flex align-items-center gap-2 small">
      <span id="meta" class="text-secondary"></span>
      <button class="btn btn-sm btn-outline-secondary" id="btnRefresh" title="Refresh"><i class="bi bi-arrow-clockwise"></i></button>
    </div>
  </div>
</nav>

<main class="container py-3">
  <div class="mb-2 d-flex flex-wrap gap-2" id="tabButtons"></div>

  <div class="viewer" id="viewer">
    <div class="d-flex h-100 align-items-center justify-content-center text-secondary">
      <div class="text-center">
        <div class="spinner-border mb-2" role="status"></div>
        <div>Memuat…</div>
      </div>
    </div>
  </div>
</main>

<script>
/* ----------------- STATE ----------------- */
let state = { rev: 0, activeIndex: 0, tabs: [], updatedAt: '' };
const STORAGE_KEY = 'picker-tabs:last-update';
const broadcast = 'BroadcastChannel' in window ? new BroadcastChannel('picker-tabs') : null;
let lastSignalTs = 0;

/* SSE (EventSource) + backoff */
let eventSource = null;
let eventSourceRetryDelay = 2000;
let eventSourceTimer = null;

/* ----------------- DATA FETCH ----------------- */
async function fetchManifestData() {
  const ts = Date.now();
  const sources = [`manifest.json?ts=${ts}`, `/api/manifest?ts=${ts}`];
  let best = null;
  let bestRevNum = null;
  let bestRevRaw;
  let bestUpdated = -Infinity;

  for (const url of sources) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) continue;
      const data = await res.json();
      if (data && typeof data === 'object' && Array.isArray(data.tabs)) {
        const revRaw = data.rev;
        const revNum = parseRevision(revRaw);
        const updatedAt = parseUpdatedAt(data.updatedAt);
        let shouldUse = false;

        if (!best) {
          shouldUse = true;
        } else if (revNum !== null && bestRevNum !== null) {
          if (revNum > bestRevNum) {
            shouldUse = true;
          } else if (revNum === bestRevNum && updatedAt > bestUpdated) {
            shouldUse = true;
          }
        } else {
          if (!revisionsEqual(bestRevRaw, revRaw)) {
            shouldUse = true;
          } else if (updatedAt > bestUpdated) {
            shouldUse = true;
          }
        }

        if (shouldUse) {
          best = data;
          bestRevNum = revNum;
          bestRevRaw = revRaw;
          bestUpdated = updatedAt;
        }
      }
    } catch (err) {
      // lanjut ke source berikutnya
      // console.debug('fetchManifestData error', url, err);
    }
  }

  return best;
}

/* ----------------- UI HELPERS ----------------- */
function iconByType(t){ return t==='pdf'?'bi-filetype-pdf':t==='image'?'bi-image':'bi-link-45deg'; }
function isLocal(url){
  // anggap lokal jika mengarah ke folder assets di domain ini
  return url.startsWith('/assets/') || url.startsWith('/boss-tabs/assets/');
}

function renderTabs(){
  const wrap = document.getElementById('tabButtons');
  wrap.innerHTML = '';
  state.tabs.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm ' + (i===state.activeIndex ? 'btn-success' : 'btn-outline-success');
    btn.innerHTML = `<i class="bi ${iconByType(t.type)} me-1"></i>${t.title}`;
    btn.onclick = () => { state.activeIndex = i; renderViewer(); renderTabs(); };
    wrap.appendChild(btn);
  });
}

function renderViewer(){
  const viewer = document.getElementById('viewer');
  viewer.innerHTML = '';
  if (!state.tabs.length) {
    viewer.innerHTML = '<div class="p-4 text-secondary">Belum ada tab. Minta operator publish dari Control.</div>';
    return;
  }
  const item = state.tabs[state.activeIndex] || state.tabs[0];
  const local = isLocal(item.url);

  if (item.type === 'image') {
    const img = document.createElement('img');
    img.src = local ? item.url : ('/api/proxy?url=' + encodeURIComponent(item.url));
    img.alt = item.title;
    img.loading = 'lazy';
    viewer.appendChild(img);
  } else if (item.type === 'link') {
    const ifr = document.createElement('iframe');
    ifr.src = item.url; // link langsung
    ifr.title = item.title;
    ifr.loading = 'lazy';
    viewer.appendChild(ifr);
  } else { // pdf
    const ifr = document.createElement('iframe');
    ifr.src = local ? item.url : ('/api/proxy?url=' + encodeURIComponent(item.url));
    ifr.title = item.title;
    ifr.loading = 'lazy';
    viewer.appendChild(ifr);
  }
}

function parseUpdatedAt(value){
  if (value instanceof Date) {
    const ts = value.getTime();
    return Number.isNaN(ts) ? 0 : ts;
  }
  if (typeof value === 'number') {
    return Number.isFinite(value) ? value : 0;
  }
  if (typeof value === 'string') {
    const parsed = Date.parse(value);
    return Number.isNaN(parsed) ? 0 : parsed;
  }
  return 0;
}

function normalizeUpdatedAt(value){
  if (value instanceof Date) {
    return Number.isNaN(value.getTime()) ? '' : value.toISOString();
  }
  if (typeof value === 'number') {
    const ts = new Date(value);
    return Number.isNaN(ts.getTime()) ? '' : ts.toISOString();
  }
  if (typeof value === 'string') return value;
  return value ? String(value) : '';
}

function renderMeta(){
  const m = document.getElementById('meta');
  const upd = state.updatedAt ? state.updatedAt.replace('T',' ').replace('Z','') : '';
  m.textContent = `Rev: ${state.rev} · Updated: ${upd}`;
}

function parseRevision(value){
  if (typeof value === 'number') return Number.isFinite(value) ? value : null;
  if (typeof value === 'string' || typeof value === 'boolean') {
    const parsed = Number(value);
    return Number.isFinite(parsed) ? parsed : null;
  }
  const parsed = Number(value);
  return Number.isFinite(parsed) ? parsed : null;
}

function revisionsEqual(a, b){
  const aNum = parseRevision(a);
  const bNum = parseRevision(b);
  if (aNum !== null && bNum !== null) return aNum === bNum;
  return `${a ?? ''}` === `${b ?? ''}`;
}

/* ----------------- LOAD + SIGNAL ----------------- */
async function load(){
  try {
    const data = await fetchManifestData();
    if (!data) return;

    const currentRev = state?.rev;
    const incomingRev = data?.rev;
    const currentUpdatedAt = state?.updatedAt ?? '';
    const incomingUpdatedAt = data?.updatedAt ?? '';
    const updatedChanged = `${currentUpdatedAt}` !== `${incomingUpdatedAt}`;

    const shouldRefresh =
      !Array.isArray(state.tabs) || !state.tabs.length ||
      !revisionsEqual(currentRev, incomingRev) ||
      updatedChanged;

    if (shouldRefresh) {
      state = {
        ...data,
        rev: incomingRev,
        updatedAt: incomingUpdatedAt ? `${incomingUpdatedAt}` : '',
      };
      if (typeof state.activeIndex !== 'number') state.activeIndex = 0;
      renderTabs();
      renderViewer();
    }
    renderMeta();
  } catch (e) {
    // console.warn('load() failed', e);
  }
}

/* terima sinyal dari berbagai jalur (SSE/Broadcast/storage) */
function handleSignal(detail){
  const candidates = [];
  if (detail && typeof detail.ts === 'number') candidates.push(detail.ts);
  if (detail && typeof detail.mtime === 'number') candidates.push(detail.mtime);
  if (detail && typeof detail.sentAt === 'number') candidates.push(detail.sentAt);
  const ts = candidates.find((v) => Number.isFinite(v)) ?? Date.now();

  if (ts <= lastSignalTs) return;
  lastSignalTs = ts;
  load();
}

/* ----------------- BROADCAST + STORAGE ----------------- */
if (broadcast) {
  broadcast.addEventListener('message', (event) => {
    if (!event?.data || event.data.type !== 'manifest-updated') return;
    handleSignal(event.data);
  });
}

window.addEventListener('storage', (event) => {
  if (event.key !== STORAGE_KEY || !event.newValue) return;
  try {
    const payload = JSON.parse(event.newValue);
    if (payload && payload.type === 'manifest-updated') {
      handleSignal(payload);
    }
  } catch (err) {}
});

/* ----------------- SSE (EventSource) ----------------- */
function scheduleManifestStreamReconnect(){
  if (!('EventSource' in window)) return;
  if (eventSourceTimer) return;
  const delay = eventSourceRetryDelay;
  eventSourceTimer = setTimeout(() => {
    eventSourceTimer = null;
    startManifestStream();
  }, delay);
  eventSourceRetryDelay = Math.min(eventSourceRetryDelay * 2, 30000);
}

function startManifestStream(){
  if (!('EventSource' in window)) return;
  if (eventSourceTimer) {
    clearTimeout(eventSourceTimer);
    eventSourceTimer = null;
  }
  if (eventSource) {
    eventSource.close();
    eventSource = null;
  }

  const es = new EventSource('/api/manifest_events');
  es.onopen = () => {
    eventSourceRetryDelay = 2000; // reset backoff saat sukses
  };
  es.onmessage = (event) => {
    if (!event.data) return;
    try {
      const payload = JSON.parse(event.data);
      if (payload && payload.type === 'manifest-updated') {
        handleSignal(payload);
      }
    } catch (err) {
      // abaikan payload yang tidak valid
    }
  };
  es.onerror = () => {
    es.close();
    if (eventSource === es) {
      eventSource = null;
    }
    scheduleManifestStreamReconnect();
  };
  eventSource = es;
}

/* ----------------- INIT ----------------- */
renderTabs(); renderViewer(); renderMeta();
load();

/* Polling sebagai baseline; SSE & sinyal akan membuatnya lebih responsif */
const POLL_MS = 2000;
setInterval(load, POLL_MS);

document.getElementById('btnRefresh').onclick = load;

/* Aktifkan SSE bila tersedia */
if ('EventSource' in window) {
  startManifestStream();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
