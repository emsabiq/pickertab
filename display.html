<!doctype html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Picker Tabs — Display</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#"><i class="bi bi-window-sidebar me-2"></i>Picker Tabs <span class="badge text-bg-success ms-1">Display</span></a>
    <div class="d-flex align-items-center gap-2 small">
      <span id="meta" class="text-secondary"></span>
      <button class="btn btn-sm btn-outline-secondary" id="btnRefresh" title="Refresh"><i class="bi bi-arrow-clockwise"></i></button>
    </div>
  </div>
</nav>

<main class="container py-3">
  <div class="mb-2 d-flex flex-wrap gap-2" id="tabButtons"></div>

  <div class="viewer" id="viewer">
    <div class="d-flex h-100 align-items-center justify-content-center text-secondary">
      <div class="text-center">
        <div class="spinner-border mb-2" role="status"></div>
        <div>Memuat…</div>
      </div>
    </div>
  </div>
</main>

<script>
let state = { rev: 0, activeIndex: 0, tabs: [], updatedAt: '' };

function iconByType(t){ return t==='pdf'?'bi-filetype-pdf':t==='image'?'bi-image':'bi-link-45deg'; }

function renderTabs(){
  const wrap = document.getElementById('tabButtons');
  wrap.innerHTML = '';
  state.tabs.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm ' + (i===state.activeIndex ? 'btn-success' : 'btn-outline-success');
    btn.innerHTML = `<i class="bi ${iconByType(t.type)} me-1"></i>${t.title}`;
    btn.onclick = () => { state.activeIndex = i; renderViewer(); renderTabs(); };
    wrap.appendChild(btn);
  });
}

function renderViewer(){
  const viewer = document.getElementById('viewer');
  viewer.innerHTML = '';
  if (!state.tabs.length) {
    viewer.innerHTML = '<div class="p-4 text-secondary">Belum ada tab. Minta operator publish dari Control.</div>';
    return;
  }
  const item = state.tabs[state.activeIndex] || state.tabs[0];
  const isLocal = item.url.startsWith('/assets/');
  if (item.type === 'image') {
    const img = document.createElement('img');
    img.src = isLocal ? item.url : ('proxy.php?url=' + encodeURIComponent(item.url));
    img.alt = item.title;
    viewer.appendChild(img);
  } else if (item.type === 'link') {
    const ifr = document.createElement('iframe');
    ifr.src = item.url; // link selalu langsung
    ifr.title = item.title;
    viewer.appendChild(ifr);
  } else { // pdf
    const ifr = document.createElement('iframe');
    ifr.src = isLocal ? item.url : ('proxy.php?url=' + encodeURIComponent(item.url));
    ifr.title = item.title;
    viewer.appendChild(ifr);
  }
}

function renderMeta(){
  const m = document.getElementById('meta');
  m.textContent = `Rev: ${state.rev} · Updated: ${state.updatedAt? state.updatedAt.replace('T',' ').replace('Z',''):''}`;
}

async function load(){
  try {
    const r = await fetch('manifest.json?ts=' + Date.now(), { cache:'no-store' });
    if (!r.ok) return;
    const data = await r.json();
    if (!state.rev || state.rev !== data.rev) {
      state = data;
      if (typeof state.activeIndex !== 'number') state.activeIndex = 0;
      renderTabs();
      renderViewer();
      renderMeta();
    }
  } catch (e) {}
}

// init
renderTabs(); renderViewer(); renderMeta();
load();
setInterval(load, 2000);

document.getElementById('btnRefresh').onclick = load;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
